<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP con Google Sheets - Mi Negocio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f1f5f9;
            --white: #ffffff;
            --google: #4285f4;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Setup Modal */
        .setup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .setup-modal.active {
            display: flex;
        }

        .setup-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .setup-step {
            display: none;
        }

        .setup-step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--light);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--primary);
            transform: scale(1.5);
        }

        .google-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--google);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .google-button:hover {
            background: #357ae8;
            transform: translateY(-2px);
        }

        .code-block {
            background: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 10px 0;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            float: right;
            margin-top: -10px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .status-indicator.disconnected {
            background: var(--danger);
        }

        .status-indicator.syncing {
            background: var(--warning);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .subtitle {
            color: var(--gray);
            margin-top: 5px;
        }

        .sync-button {
            background: var(--google);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .sync-button:hover {
            background: #357ae8;
            transform: translateY(-2px);
        }

        .sync-button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            border-radius: 10px;
        }

        .tab-btn:hover {
            background: var(--light);
        }

        .tab-btn.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Date Filters */
        .date-filter-container {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            color: white;
        }

        .date-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .date-input-group label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .date-input-group input[type="date"] {
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .date-input-group input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: white;
            background: rgba(255,255,255,0.2);
        }

        .filter-btn {
            padding: 10px 20px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .quick-filter-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .card.warning { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); }
        .card.danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
        .card.info { background: linear-gradient(135deg, var(--secondary) 0%, #06b6d4 100%); }

        .card h3 {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .card .period {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--light);
            padding: 12px;
            text-align: left;
            color: var(--dark);
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--light);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--dark);
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-info {
            background: rgba(34, 211, 238, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(34, 211, 238, 0.3);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(34, 211, 238, 0.2);
            color: var(--secondary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .instructions-list {
            margin: 20px 0;
            padding-left: 20px;
        }

        .instructions-list li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .date-filter-row {
                grid-template-columns: 1fr;
            }
            
            .header-top {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <div class="status-indicator disconnected" id="statusIndicator"></div>
        <span id="statusText">Configurando...</span>
    </div>

    <!-- Setup Modal -->
    <div class="setup-modal active" id="setupModal">
        <div class="setup-content">
            <div class="step-indicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div class="setup-step active" id="step1">
                <h2>üöÄ Bienvenido al Sistema ERP con Google Sheets</h2>
                <p style="color: var(--gray); margin: 20px 0;">
                    Este sistema sincronizar√° todos tus datos con Google Sheets para que puedas acceder desde cualquier dispositivo.
                </p>
                
                <div class="alert alert-info">
                    <strong>Ventajas:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>‚úÖ Acceso desde cualquier dispositivo</li>
                        <li>‚úÖ Backup autom√°tico en la nube</li>
                        <li>‚úÖ Compartir datos con tu equipo</li>
                        <li>‚úÖ Historial completo en Google Sheets</li>
                        <li>‚úÖ Gratis y seguro</li>
                    </ul>
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Necesitar√°s:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Una cuenta de Google</li>
                        <li>5 minutos para la configuraci√≥n inicial</li>
                    </ul>
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="google-button" onclick="nextStep()">
                        <span>Comenzar Configuraci√≥n</span> ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Create Spreadsheet -->
            <div class="setup-step" id="step2">
                <h2>üìä Paso 1: Crear la Hoja de Google</h2>
                
                <ol class="instructions-list">
                    <li>
                        <strong>Haz clic en el bot√≥n para crear tu hoja de datos:</strong>
                        <div style="margin: 15px 0;">
                            <a href="https://sheets.google.com/create" target="_blank" class="google-button">
                                üìÑ Crear Nueva Hoja de Google
                            </a>
                        </div>
                    </li>
                    
                    <li>
                        <strong>Renombra la hoja como "ERP_MiNegocio"</strong>
                        <br><small>(Haz clic en "Hoja de c√°lculo sin t√≠tulo" y escribe el nuevo nombre)</small>
                    </li>
                    
                    <li>
                        <strong>Copia el ID de tu hoja:</strong>
                        <br>El ID est√° en la URL, es el texto entre /d/ y /edit
                        <div class="code-block">
                            https://docs.google.com/spreadsheets/d/<span style="color: #10b981;">ESTE_ES_EL_ID</span>/edit
                        </div>
                    </li>
                    
                    <li>
                        <strong>Pega el ID aqu√≠:</strong>
                        <input type="text" class="form-control" id="spreadsheetId" placeholder="Ej: 1ABC123def456..." style="margin-top: 10px;">
                    </li>
                </ol>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-danger" onclick="previousStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="validateAndNext()">Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Setup Script -->
            <div class="setup-step" id="step3">
                <h2>‚öôÔ∏è Paso 2: Configurar Google Apps Script</h2>
                
                <ol class="instructions-list">
                    <li>
                        <strong>Abre Google Apps Script:</strong>
                        <div style="margin: 15px 0;">
                            <a href="https://script.google.com/home/projects/create" target="_blank" class="google-button">
                                ‚öôÔ∏è Crear Nuevo Script
                            </a>
                        </div>
                    </li>
                    
                    <li>
                        <strong>Borra todo el c√≥digo que aparece y pega este:</strong>
                        <div style="position: relative;">
                            <button class="copy-btn" onclick="copyCode()">üìã Copiar</button>
                            <div class="code-block" id="scriptCode">
// Sistema ERP - Google Sheets Backend
const SHEET_ID = 'TU_ID_AQUI'; // Cambia esto por tu ID

function doGet(e) {
  const action = e.parameter.action;
  const sheet = SpreadsheetApp.openById(SHEET_ID);
  
  if (action === 'getProducts') {
    return getProducts(sheet);
  } else if (action === 'getSales') {
    return getSales(sheet);
  } else if (action === 'init') {
    return initializeSheets(sheet);
  }
  
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const sheet = SpreadsheetApp.openById(SHEET_ID);
  const data = JSON.parse(e.postData.contents);
  const action = data.action;
  
  if (action === 'saveProduct') {
    return saveProduct(sheet, data.product);
  } else if (action === 'updateProduct') {
    return updateProduct(sheet, data.product);
  } else if (action === 'deleteProduct') {
    return deleteProduct(sheet, data.productId);
  } else if (action === 'saveSale') {
    return saveSale(sheet, data.sale);
  } else if (action === 'updateStock') {
    return updateStock(sheet, data.productId, data.newStock);
  }
  
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function initializeSheets(spreadsheet) {
  // Create Products sheet
  let productsSheet;
  try {
    productsSheet = spreadsheet.getSheetByName('Products');
  } catch(e) {
    productsSheet = spreadsheet.insertSheet('Products');
    productsSheet.getRange(1, 1, 1, 8).setValues([
      ['ID', 'Code', 'Name', 'Category', 'Stock', 'Price', 'Cost', 'Description']
    ]);
    productsSheet.getRange(1, 1, 1, 8).setFontWeight('bold');
  }
  
  // Create Sales sheet
  let salesSheet;
  try {
    salesSheet = spreadsheet.getSheetByName('Sales');
  } catch(e) {
    salesSheet = spreadsheet.insertSheet('Sales');
    salesSheet.getRange(1, 1, 1, 10).setValues([
      ['ID', 'Date', 'Customer', 'ProductID', 'ProductName', 'Quantity', 'UnitPrice', 'Total', 'Profit', 'Notes']
    ]);
    salesSheet.getRange(1, 1, 1, 10).setFontWeight('bold');
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true, message: 'Sheets initialized'}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function getProducts(spreadsheet) {
  const sheet = spreadsheet.getSheetByName('Products');
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({products: []}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({'Access-Control-Allow-Origin': '*'});
  }
  
  const data = sheet.getDataRange().getValues();
  const products = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      products.push({
        id: data[i][0],
        code: data[i][1],
        name: data[i][2],
        category: data[i][3],
        stock: data[i][4],
        price: data[i][5],
        cost: data[i][6],
        description: data[i][7]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({products}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function getSales(spreadsheet) {
  const sheet = spreadsheet.getSheetByName('Sales');
  if (!sheet) {
    return ContentService.createTextOutput(JSON.stringify({sales: []}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({'Access-Control-Allow-Origin': '*'});
  }
  
  const data = sheet.getDataRange().getValues();
  const sales = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      sales.push({
        id: data[i][0],
        date: data[i][1],
        customer: data[i][2],
        productId: data[i][3],
        productName: data[i][4],
        quantity: data[i][5],
        unitPrice: data[i][6],
        total: data[i][7],
        profit: data[i][8],
        notes: data[i][9]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({sales}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function saveProduct(spreadsheet, product) {
  const sheet = spreadsheet.getSheetByName('Products');
  product.id = new Date().getTime().toString();
  
  sheet.appendRow([
    product.id,
    product.code,
    product.name,
    product.category,
    product.stock,
    product.price,
    product.cost,
    product.description
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({success: true, product}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function updateProduct(spreadsheet, product) {
  const sheet = spreadsheet.getSheetByName('Products');
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == product.id) {
      sheet.getRange(i + 1, 1, 1, 8).setValues([[
        product.id,
        product.code,
        product.name,
        product.category,
        product.stock,
        product.price,
        product.cost,
        product.description
      ]]);
      break;
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function deleteProduct(spreadsheet, productId) {
  const sheet = spreadsheet.getSheetByName('Products');
  const data = sheet.getDataRange().getValues();
  
  for (let i = data.length - 1; i >= 1; i--) {
    if (data[i][0] == productId) {
      sheet.deleteRow(i + 1);
      break;
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function saveSale(spreadsheet, sale) {
  const sheet = spreadsheet.getSheetByName('Sales');
  sale.id = new Date().getTime().toString();
  
  sheet.appendRow([
    sale.id,
    sale.date,
    sale.customer,
    sale.productId,
    sale.productName,
    sale.quantity,
    sale.unitPrice,
    sale.total,
    sale.profit,
    sale.notes
  ]);
  
  // Update product stock
  updateStock(spreadsheet, sale.productId, sale.newStock);
  
  return ContentService.createTextOutput(JSON.stringify({success: true, sale}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}

function updateStock(spreadsheet, productId, newStock) {
  const sheet = spreadsheet.getSheetByName('Products');
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == productId) {
      sheet.getRange(i + 1, 5).setValue(newStock);
      break;
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({'Access-Control-Allow-Origin': '*'});
}
                            </div>
                        </div>
                    </li>
                    
                    <li>
                        <strong>IMPORTANTE: Cambia 'TU_ID_AQUI' por el ID de tu hoja</strong>
                        <br>En la l√≠nea 2 del c√≥digo, reemplaza con tu ID:
                        <div class="code-block">
                            const SHEET_ID = '<span id="sheetIdDisplay" style="color: #10b981;">tu_id_aqui</span>';
                        </div>
                    </li>
                    
                    <li>
                        <strong>Guarda el proyecto:</strong>
                        <br>‚Ä¢ Haz clic en el icono de disco üíæ o presiona Ctrl+S
                        <br>‚Ä¢ Ponle nombre: "ERP_Backend"
                    </li>
                </ol>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-danger" onclick="previousStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="nextStep()">Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Deploy -->
            <div class="setup-step" id="step4">
                <h2>üåê Paso 3: Publicar el Script</h2>
                
                <ol class="instructions-list">
                    <li>
                        <strong>En Google Apps Script, haz clic en "Implementar" ‚Üí "Nueva implementaci√≥n"</strong>
                    </li>
                    
                    <li>
                        <strong>Configura la implementaci√≥n:</strong>
                        <br>‚Ä¢ Haz clic en el engranaje ‚öôÔ∏è ‚Üí "Aplicaci√≥n web"
                        <br>‚Ä¢ Descripci√≥n: "ERP API"
                        <br>‚Ä¢ Ejecutar como: "Yo"
                        <br>‚Ä¢ Qui√©n tiene acceso: "Cualquier persona"
                    </li>
                    
                    <li>
                        <strong>Haz clic en "Implementar"</strong>
                        <br>‚Ä¢ Autoriza los permisos cuando te lo pida
                        <br>‚Ä¢ Si aparece "No verificada", haz clic en "Avanzado" ‚Üí "Ir a ERP_Backend (no seguro)"
                    </li>
                    
                    <li>
                        <strong>Copia la URL de la aplicaci√≥n web:</strong>
                        <br>Se ver√° algo as√≠:
                        <div class="code-block">
                            https://script.google.com/macros/s/AKfyc.../exec
                        </div>
                        
                        <input type="text" class="form-control" id="scriptUrl" placeholder="Pega aqu√≠ la URL de tu script" style="margin-top: 10px;">
                    </li>
                </ol>

                <div class="success-box">
                    <strong>‚úÖ ¬°Casi listo!</strong>
                    <br>Una vez que pegues la URL, el sistema estar√° configurado y listo para usar.
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-danger" onclick="previousStep()">‚Üê Anterior</button>
                    <button class="btn btn-success" onclick="completeSetup()">‚úÖ Completar Configuraci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>
                        <span>üìä</span> Sistema ERP
                    </h1>
                    <p class="subtitle">Sincronizado con Google Sheets</p>
                </div>
                <button class="sync-button" id="syncButton" onclick="syncData()" disabled>
                    <span>üîÑ</span> Sincronizar
                </button>
            </div>
            
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('dashboard')">
                    üìà Dashboard
                </button>
                <button class="tab-btn" onclick="showTab('products')">
                    üì¶ Productos
                </button>
                <button class="tab-btn" onclick="showTab('sales')">
                    üí∞ Ventas
                </button>
                <button class="tab-btn" onclick="showTab('reports')">
                    üìä Reportes
                </button>
                <button class="tab-btn" onclick="showTab('settings')">
                    ‚öôÔ∏è Configuraci√≥n
                </button>
            </div>
        </div>

        <div class="content-area">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: var(--dark);">Panel Principal</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Total Productos</h3>
                        <div class="value" id="totalProducts">0</div>
                        <div class="period">En inventario</div>
                    </div>
                    <div class="card success">
                        <h3>Ventas del Mes</h3>
                        <div class="value" id="monthSales">$0</div>
                        <div class="period" id="salesCount">0 ventas</div>
                    </div>
                    <div class="card warning">
                        <h3>Stock Bajo</h3>
                        <div class="value" id="lowStock">0</div>
                        <div class="period">Productos</div>
                    </div>
                    <div class="card danger">
                        <h3>Ganancias del Mes</h3>
                        <div class="value" id="monthProfit">$0</div>
                        <div class="period" id="profitMargin">0% margen</div>
                    </div>
                </div>

                <div class="table-container" style="background: white; padding: 20px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">√öltimas Ventas</h3>
                    <div id="recentSalesChart"></div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--dark);">Gesti√≥n de Productos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        + Nuevo Producto
                    </button>
                </div>

                <div class="table-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Stock</th>
                                <th>Precio</th>
                                <th>Costo</th>
                                <th>Margen</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be inserted here -->
                        </tbody>
                    </table>
                    <div id="noProducts" class="empty-state" style="display: none;">
                        <h3>No hay productos registrados</h3>
                        <p>Comienza agregando tu primer producto</p>
                    </div>
                </div>
            </div>

            <!-- Sales Tab -->
            <div id="sales" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--dark);">Registro de Ventas</h2>
                    <button class="btn btn-success" onclick="openSaleModal()">
                        + Nueva Venta
                    </button>
                </div>

                <div class="table-container">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Total</th>
                                <th>Ganancia</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <!-- Sales will be inserted here -->
                        </tbody>
                    </table>
                    <div id="noSales" class="empty-state" style="display: none;">
                        <h3>No hay ventas registradas</h3>
                        <p>Registra tu primera venta para comenzar</p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px; color: var(--dark);">Reportes y An√°lisis</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Ventas Totales</h3>
                        <div class="value" id="totalSalesAmount">$0</div>
                    </div>
                    <div class="card success">
                        <h3>Ganancia Total</h3>
                        <div class="value" id="totalProfitAmount">$0</div>
                    </div>
                    <div class="card warning">
                        <h3>Margen Promedio</h3>
                        <div class="value" id="avgMargin">0%</div>
                    </div>
                    <div class="card info">
                        <h3>Producto M√°s Vendido</h3>
                        <div class="value" id="topProduct" style="font-size: 1.2rem;">-</div>
                    </div>
                </div>

                <div class="table-container" style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">Resumen por Producto</h3>
                    <div id="productSummary"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: var(--dark);">Configuraci√≥n</h2>
                
                <div class="alert alert-info">
                    <strong>Estado de la Conexi√≥n:</strong>
                    <span id="connectionInfo">Verificando...</span>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">Informaci√≥n de Google Sheets</h3>
                    <div class="form-group">
                        <label>ID de la Hoja:</label>
                        <input type="text" class="form-control" id="settingsSheetId" readonly>
                    </div>
                    <div class="form-group">
                        <label>URL del Script:</label>
                        <input type="text" class="form-control" id="settingsScriptUrl" readonly>
                    </div>
                    <button class="btn btn-warning" onclick="resetConfiguration()">üîÑ Reconfigurar</button>
                    <button class="btn btn-success" onclick="openSheetInNewTab()">üìä Abrir Google Sheets</button>
                </div>

                <div style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">Backup y Restauraci√≥n</h3>
                    <button class="btn btn-primary" onclick="exportData()">üíæ Exportar Datos</button>
                    <button class="btn btn-danger" onclick="clearLocalData()">üóëÔ∏è Limpiar Datos Locales</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeProductModal()">&times;</span>
                <h2 id="productModalTitle">Nuevo Producto</h2>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Producto</label>
                        <input type="text" class="form-control" id="productCode" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <input type="text" class="form-control" id="productCategory" required>
                    </div>
                    <div class="form-group">
                        <label>Stock Inicial</label>
                        <input type="number" class="form-control" id="productStock" required min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Precio de Venta</label>
                        <input type="number" class="form-control" id="productPrice" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Costo</label>
                        <input type="number" class="form-control" id="productCost" required min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Descripci√≥n (Opcional)</label>
                    <textarea class="form-control" id="productDescription" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sale Modal -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeSaleModal()">&times;</span>
                <h2>Nueva Venta</h2>
            </div>
            <form id="saleForm" onsubmit="saveSale(event)">
                <div class="form-group">
                    <label>Fecha de Venta</label>
                    <input type="datetime-local" class="form-control" id="saleDate" required>
                </div>

                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" class="form-control" id="customerName" required placeholder="Nombre del cliente">
                </div>
                
                <div class="form-group">
                    <label>Producto</label>
                    <select class="form-control" id="saleProduct" required onchange="updateSalePrice()">
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" class="form-control" id="saleQuantity" required min="1" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label>Precio Unitario (Personalizable)</label>
                        <input type="number" class="form-control" id="salePrice" required min="0" step="0.01" onchange="calculateTotal()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Total</label>
                    <input type="text" class="form-control" id="saleTotal" readonly style="font-weight: bold; font-size: 1.2rem;">
                </div>
                
                <div class="form-group">
                    <label>Notas (Opcional)</label>
                    <textarea class="form-control" id="saleNotes" rows="2" placeholder="Ej: Descuento especial, cliente frecuente, etc."></textarea>
                </div>
                
                <div class="alert alert-info">
                    üí° Puedes modificar el precio unitario para aplicar descuentos o precios especiales
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeSaleModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            spreadsheetId: localStorage.getItem('erpSpreadsheetId') || '',
            scriptUrl: localStorage.getItem('erpScriptUrl') || ''
        };

        // Data
        let products = [];
        let sales = [];
        let editingProductId = null;
        let currentStep = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkConfiguration();
            document.getElementById('saleDate').value = new Date().toISOString().slice(0, 16);
        });

        // Setup Functions
        function checkConfiguration() {
            if (config.spreadsheetId && config.scriptUrl) {
                document.getElementById('setupModal').classList.remove('active');
                initializeSystem();
            } else {
                document.getElementById('setupModal').classList.add('active');
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateStepIndicator();
                
                if (currentStep === 3 && document.getElementById('spreadsheetId').value) {
                    document.getElementById('sheetIdDisplay').textContent = document.getElementById('spreadsheetId').value;
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateStepIndicator();
            }
        }

        function updateStepIndicator() {
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentStep - 1);
            });
        }

        function validateAndNext() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            if (!spreadsheetId) {
                alert('Por favor, ingresa el ID de tu hoja de Google');
                return;
            }
            nextStep();
        }

        function copyCode() {
            const code = document.getElementById('scriptCode').innerText;
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const modifiedCode = code.replace('TU_ID_AQUI', spreadsheetId);
            
            navigator.clipboard.writeText(modifiedCode).then(() => {
                alert('‚úÖ C√≥digo copiado al portapapeles!\nRecuerda reemplazar TU_ID_AQUI con tu ID: ' + spreadsheetId);
            });
        }

        async function completeSetup() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            
            if (!spreadsheetId || !scriptUrl) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Save configuration
            localStorage.setItem('erpSpreadsheetId', spreadsheetId);
            localStorage.setItem('erpScriptUrl', scriptUrl);
            config.spreadsheetId = spreadsheetId;
            config.scriptUrl = scriptUrl;
            
            // Initialize sheets
            try {
                const response = await fetch(scriptUrl + '?action=init');
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ¬°Configuraci√≥n completada con √©xito!');
                    document.getElementById('setupModal').classList.remove('active');
                    initializeSystem();
                }
            } catch (error) {
                alert('Error al conectar con Google Sheets. Verifica la URL del script.');
                console.error(error);
            }
        }

        // System Initialization
        async function initializeSystem() {
            updateConnectionStatus('syncing', 'Conectando...');
            document.getElementById('settingsSheetId').value = config.spreadsheetId;
            document.getElementById('settingsScriptUrl').value = config.scriptUrl;
            
            try {
                await loadFromSheets();
                updateConnectionStatus('connected', 'Conectado a Google Sheets');
                document.getElementById('syncButton').disabled = false;
                updateDashboard();
                updateReports();
            } catch (error) {
                console.error('Error loading data:', error);
                updateConnectionStatus('disconnected', 'Error de conexi√≥n');
                // Load from local storage as fallback
                loadFromLocal();
            }
        }

        // Connection Status
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
            
            document.getElementById('connectionInfo').textContent = text;
        }

        // Google Sheets Functions
        async function loadFromSheets() {
            try {
                // Load products
                const productsResponse = await fetch(config.scriptUrl + '?action=getProducts');
                const productsData = await productsResponse.json();
                products = productsData.products || [];
                
                // Load sales
                const salesResponse = await fetch(config.scriptUrl + '?action=getSales');
                const salesData = await salesResponse.json();
                sales = salesData.sales || [];
                
                // Update local storage
                localStorage.setItem('erpProducts', JSON.stringify(products));
                localStorage.setItem('erpSales', JSON.stringify(sales));
                
                // Update UI
                loadProducts();
                loadSales();
                
                return true;
            } catch (error) {
                console.error('Error loading from sheets:', error);
                throw error;
            }
        }

        function loadFromLocal() {
            products = JSON.parse(localStorage.getItem('erpProducts')) || [];
            sales = JSON.parse(localStorage.getItem('erpSales')) || [];
            loadProducts();
            loadSales();
            updateDashboard();
            updateReports();
        }

        async function syncData() {
            updateConnectionStatus('syncing', 'Sincronizando...');
            document.getElementById('syncButton').disabled = true;
            
            try {
                await loadFromSheets();
                updateConnectionStatus('connected', 'Sincronizado');
                updateDashboard();
                updateReports();
            } catch (error) {
                updateConnectionStatus('disconnected', 'Error al sincronizar');
                alert('Error al sincronizar. Trabajando offline.');
            } finally {
                document.getElementById('syncButton').disabled = false;
            }
        }

        // Tab Management
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'reports') {
                updateReports();
            }
        }

        // Product Management
        function openProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                document.getElementById('productModalTitle').textContent = 'Editar Producto';
                document.getElementById('productCode').value = product.code;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCost').value = product.cost;
                document.getElementById('productDescription').value = product.description || '';
                editingProductId = productId;
            } else {
                document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
                form.reset();
                editingProductId = null;
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productForm').reset();
            editingProductId = null;
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const productData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value),
                price: parseFloat(document.getElementById('productPrice').value),
                cost: parseFloat(document.getElementById('productCost').value),
                description: document.getElementById('productDescription').value
            };
            
            try {
                if (editingProductId) {
                    productData.id = editingProductId;
                    await updateProductInSheets(productData);
                } else {
                    await saveProductToSheets(productData);
                }
                
                await loadFromSheets();
                updateDashboard();
                closeProductModal();
            } catch (error) {
                console.error('Error saving product:', error);
                // Save locally as fallback
                if (editingProductId) {
                    const index = products.findIndex(p => p.id === editingProductId);
                    products[index] = { ...products[index], ...productData };
                } else {
                    productData.id = Date.now().toString();
                    products.push(productData);
                }
                localStorage.setItem('erpProducts', JSON.stringify(products));
                loadProducts();
                updateDashboard();
                closeProductModal();
                alert('Guardado localmente. Se sincronizar√° cuando haya conexi√≥n.');
            }
        }

        async function saveProductToSheets(product) {
            const response = await fetch(config.scriptUrl, {
                method: 'POST',
                body: JSON.stringify({ action: 'saveProduct', product })
            });
            return response.json();
        }

        async function updateProductInSheets(product) {
            const response = await fetch(config.scriptUrl, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateProduct', product })
            });
            return response.json();
        }

        async function deleteProduct(productId) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                try {
                    const response = await fetch(config.scriptUrl, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'deleteProduct', productId })
                    });
                    await response.json();
                    await loadFromSheets();
                    updateDashboard();
                } catch (error) {
                    // Delete locally as fallback
                    products = products.filter(p => p.id !== productId);
                    localStorage.setItem('erpProducts', JSON.stringify(products));
                    loadProducts();
                    updateDashboard();
                    alert('Eliminado localmente. Se sincronizar√° cuando haya conexi√≥n.');
                }
            }
        }

        function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            const noProducts = document.getElementById('noProducts');
            
            if (products.length === 0) {
                tbody.innerHTML = '';
                noProducts.style.display = 'block';
                return;
            }
            
            noProducts.style.display = 'none';
            tbody.innerHTML = products.map(product => {
                const margin = ((product.price - product.cost) / product.price * 100).toFixed(1);
                const stockStatus = product.stock < 10 ? 'badge-danger' : product.stock < 30 ? 'badge-warning' : 'badge-success';
                
                return `
                    <tr>
                        <td>${product.code}</td>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.category}</td>
                        <td><span class="badge ${stockStatus}">${product.stock} un.</span></td>
                        <td>$${parseFloat(product.price).toFixed(2)}</td>
                        <td>$${parseFloat(product.cost).toFixed(2)}</td>
                        <td><span class="badge badge-success">${margin}%</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="openProductModal('${product.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Sales Management
        function openSaleModal() {
            const modal = document.getElementById('saleModal');
            const select = document.getElementById('saleProduct');
            
            document.getElementById('saleDate').value = new Date().toISOString().slice(0, 16);
            
            select.innerHTML = '<option value="">Seleccionar producto...</option>' + 
                products.map(p => `<option value="${p.id}" data-price="${p.price}" data-cost="${p.cost}" data-stock="${p.stock}">${p.name} (Stock: ${p.stock})</option>`).join('');
            
            document.getElementById('saleForm').reset();
            document.getElementById('saleDate').value = new Date().toISOString().slice(0, 16);
            modal.classList.add('active');
        }

        function closeSaleModal() {
            document.getElementById('saleModal').classList.remove('active');
        }

        function updateSalePrice() {
            const select = document.getElementById('saleProduct');
            const option = select.options[select.selectedIndex];
            if (option.value) {
                document.getElementById('salePrice').value = option.getAttribute('data-price');
                calculateTotal();
            }
        }

        function calculateTotal() {
            const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const total = quantity * price;
            document.getElementById('saleTotal').value = '$' + total.toFixed(2);
        }

        async function saveSale(event) {
            event.preventDefault();
            
            const productId = document.getElementById('saleProduct').value;
            const product = products.find(p => p.id === productId);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            
            if (product.stock < quantity) {
                alert('No hay suficiente stock disponible. Stock actual: ' + product.stock);
                return;
            }
            
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            const total = quantity * salePrice;
            const profit = (salePrice - product.cost) * quantity;
            
            const saleData = {
                date: document.getElementById('saleDate').value,
                customer: document.getElementById('customerName').value,
                productId: productId,
                productName: product.name,
                quantity: quantity,
                unitPrice: salePrice,
                total: total,
                profit: profit,
                notes: document.getElementById('saleNotes').value,
                newStock: product.stock - quantity
            };
            
            try {
                const response = await fetch(config.scriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveSale', sale: saleData })
                });
                await response.json();
                await loadFromSheets();
                updateDashboard();
                closeSaleModal();
            } catch (error) {
                // Save locally as fallback
                saleData.id = Date.now().toString();
                sales.push(saleData);
                product.stock -= quantity;
                localStorage.setItem('erpSales', JSON.stringify(sales));
                localStorage.setItem('erpProducts', JSON.stringify(products));
                loadSales();
                loadProducts();
                updateDashboard();
                closeSaleModal();
                alert('Venta guardada localmente. Se sincronizar√° cuando haya conexi√≥n.');
            }
        }

        function loadSales() {
            const tbody = document.getElementById('salesTableBody');
            const noSales = document.getElementById('noSales');
            
            if (sales.length === 0) {
                tbody.innerHTML = '';
                noSales.style.display = 'block';
                return;
            }
            
            noSales.style.display = 'none';
            tbody.innerHTML = sales.slice().reverse().map(sale => {
                const date = new Date(sale.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const profitClass = parseFloat(sale.profit) > 0 ? 'badge-success' : 'badge-danger';
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${sale.customer}</td>
                        <td>${sale.productName}</td>
                        <td>${sale.quantity}</td>
                        <td>$${parseFloat(sale.unitPrice).toFixed(2)}</td>
                        <td><strong>$${parseFloat(sale.total).toFixed(2)}</strong></td>
                        <td><span class="badge ${profitClass}">$${parseFloat(sale.profit).toFixed(2)}</span></td>
                        <td>${sale.notes || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Dashboard
        function updateDashboard() {
            // Total products
            document.getElementById('totalProducts').textContent = products.length;
            
            // Month sales
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthSales = sales.filter(s => {
                const saleDate = new Date(s.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            
            const monthTotal = monthSales.reduce((sum, s) => sum + parseFloat(s.total), 0);
            document.getElementById('monthSales').textContent = '$' + monthTotal.toFixed(2);
            document.getElementById('salesCount').textContent = monthSales.length + ' ventas';
            
            // Low stock
            const lowStock = products.filter(p => p.stock < 10).length;
            document.getElementById('lowStock').textContent = lowStock;
            
            // Month profit
            const monthProfit = monthSales.reduce((sum, s) => sum + parseFloat(s.profit), 0);
            document.getElementById('monthProfit').textContent = '$' + monthProfit.toFixed(2);
            const profitMargin = monthTotal > 0 ? (monthProfit / monthTotal * 100).toFixed(1) : 0;
            document.getElementById('profitMargin').textContent = profitMargin + '% margen';
            
            // Recent sales
            updateRecentSales();
        }

        function updateRecentSales() {
            const recentSales = sales.slice(-10).reverse();
            const container = document.getElementById('recentSalesChart');
            
            if (recentSales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray);">No hay ventas recientes</p>';
                return;
            }
            
            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Producto</th>
                            <th>Total</th>
                            <th>Ganancia</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recentSales.map(sale => `
                            <tr>
                                <td>${new Date(sale.date).toLocaleDateString()}</td>
                                <td>${sale.customer}</td>
                                <td>${sale.productName}</td>
                                <td>$${parseFloat(sale.total).toFixed(2)}</td>
                                <td><span class="badge badge-success">$${parseFloat(sale.profit).toFixed(2)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Reports
        function updateReports() {
            const totalSales = sales.reduce((sum, s) => sum + parseFloat(s.total), 0);
            document.getElementById('totalSalesAmount').textContent = '$' + totalSales.toFixed(2);
            
            const totalProfit = sales.reduce((sum, s) => sum + parseFloat(s.profit), 0);
            document.getElementById('totalProfitAmount').textContent = '$' + totalProfit.toFixed(2);
            
            const avgMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
            document.getElementById('avgMargin').textContent = avgMargin.toFixed(1) + '%';
            
            // Top product
            const productSales = {};
            sales.forEach(sale => {
                if (!productSales[sale.productName]) {
                    productSales[sale.productName] = 0;
                }
                productSales[sale.productName] += sale.quantity;
            });
            
            const topProduct = Object.entries(productSales).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topProduct').textContent = topProduct ? topProduct[0] : '-';
            
            updateProductSummary();
        }

        function updateProductSummary() {
            const summaryContainer = document.getElementById('productSummary');
            
            const productStats = products.map(product => {
                const productSales = sales.filter(s => s.productId === product.id);
                const totalSold = productSales.reduce((sum, s) => sum + parseInt(s.quantity), 0);
                const totalRevenue = productSales.reduce((sum, s) => sum + parseFloat(s.total), 0);
                const totalProfit = productSales.reduce((sum, s) => sum + parseFloat(s.profit), 0);
                
                return {
                    name: product.name,
                    sold: totalSold,
                    revenue: totalRevenue,
                    profit: totalProfit,
                    stock: product.stock
                };
            }).filter(p => p.sold > 0);
            
            if (productStats.length === 0) {
                summaryContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">No hay datos de ventas</p>';
                return;
            }
            
            summaryContainer.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Vendidos</th>
                            <th>Ingresos</th>
                            <th>Ganancia</th>
                            <th>Stock Actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productStats.map(stat => `
                            <tr>
                                <td><strong>${stat.name}</strong></td>
                                <td>${stat.sold} un.</td>
                                <td>$${stat.revenue.toFixed(2)}</td>
                                <td><span class="badge badge-success">$${stat.profit.toFixed(2)}</span></td>
                                <td><span class="badge ${stat.stock < 10 ? 'badge-danger' : 'badge-success'}">${stat.stock} un.</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Settings Functions
        function resetConfiguration() {
            if (confirm('¬øEst√°s seguro? Tendr√°s que reconfigurar la conexi√≥n con Google Sheets')) {
                localStorage.removeItem('erpSpreadsheetId');
                localStorage.removeItem('erpScriptUrl');
                location.reload();
            }
        }

        function openSheetInNewTab() {
            if (config.spreadsheetId) {
                window.open(`https://docs.google.com/spreadsheets/d/${config.spreadsheetId}/edit`, '_blank');
            }
        }

        function exportData() {
            const data = {
                products: products,
                sales: sales,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `erp_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function clearLocalData() {
            if (confirm('¬øEst√°s seguro? Los datos locales se eliminar√°n (los datos en Google Sheets no se afectar√°n)')) {
                localStorage.removeItem('erpProducts');
                localStorage.removeItem('erpSales');
                location.reload();
            }
        }
    </script>
</body>
</html>
