<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BERSERKER.CO - ERP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .navbar {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar h1 {
            text-align: center;
            font-size: 1.5rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            min-width: 120px;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            height: fit-content;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .menu-item {
            display: block;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover,
        .menu-item.active {
            background: #007bff;
            color: white;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin: 0.1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .delivery-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .delivery-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-assigned { background: #d1ecf1; color: #0c5460; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }

        .delivery-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .info-item {
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: bold;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                gap: 1rem;
            }
            
            .stat-item {
                min-width: 100px;
                font-size: 0.8rem;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>‚öîÔ∏è BERSERKER.CO</h1>
        <div class="stats-bar">
            <div class="stat-item">
                <div id="totalProducts">0</div>
                <div>Productos</div>
            </div>
            <div class="stat-item">
                <div id="totalOrders">0</div>
                <div>Pedidos</div>
            </div>
            <div class="stat-item">
                <div id="totalRevenue">‚Ç≤0</div>
                <div>Ingresos</div>
            </div>
            <div class="stat-item">
                <div id="totalExpenses">‚Ç≤0</div>
                <div>Gastos</div>
            </div>
            <div class="stat-item">
                <div id="totalProfit">‚Ç≤0</div>
                <div>Ganancia</div>
            </div>
            <div class="stat-item">
                <div id="pendingDeliveries">0</div>
                <div>Entregas Pendientes</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-grid">
            <div class="sidebar">
                <div class="menu-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
                <div class="menu-item" onclick="showSection('products')">üõçÔ∏è Productos</div>
                <div class="menu-item" onclick="showSection('orders')">üõí Pedidos</div>
                <div class="menu-item" onclick="showSection('deliveries')">üöö Entregas</div>
                <div class="menu-item" onclick="showSection('expenses')">üí∏ Gastos</div>
                <div class="menu-item" onclick="showSection('cashflow')">üí∞ Flujo de Caja</div>
            </div>

            <div class="content">
                <!-- Dashboard -->
                <div id="dashboard" class="section active">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="dashProducts">0</div>
                            <div class="stat-label">Productos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashOrders">0</div>
                            <div class="stat-label">Pedidos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashRevenue">‚Ç≤0</div>
                            <div class="stat-label">Ingresos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashProfit">‚Ç≤0</div>
                            <div class="stat-label">Ganancia</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashPendingDeliveries">0</div>
                            <div class="stat-label">Entregas Pendientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashDeliveryRate">0%</div>
                            <div class="stat-label">Tasa de Entrega</div>
                        </div>
                    </div>
                    
                    <h3>Acciones R√°pidas</h3>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="openModal('productModal')">+ Nuevo Producto</button>
                        <button class="btn btn-info" onclick="openModal('orderModal')">+ Nuevo Pedido</button>
                        <button class="btn btn-danger" onclick="openModal('expenseModal')">+ Nuevo Gasto</button>
                        <button class="btn btn-warning" onclick="generateSampleData()">üìä Datos de Prueba</button>
                    </div>
                </div>

                <!-- Productos -->
                <div id="products" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>Productos</h2>
                        <button class="btn btn-success" onclick="openModal('productModal')">+ Nuevo Producto</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Proveedor</th>
                                <th>Stock</th>
                                <th>Costo</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                                    No hay productos. Agrega tu primer producto.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pedidos -->
                <div id="orders" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>Pedidos</h2>
                        <button class="btn btn-info" onclick="openModal('orderModal')">+ Nuevo Pedido</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                                    No hay pedidos. Crea tu primer pedido.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Entregas -->
                <div id="deliveries" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>Gesti√≥n de Entregas</h2>
                        <button class="btn btn-info" onclick="syncDeliveries()">üîÑ Sincronizar Pedidos</button>
                    </div>
                    
                    <div class="filters">
                        <select id="deliveryFilter" class="form-control" onchange="filterDeliveries()" style="width: auto; min-width: 150px;">
                            <option value="all">Todas las entregas</option>
                            <option value="pending">Pendientes</option>
                            <option value="assigned">Asignadas</option>
                            <option value="in-progress">En camino</option>
                            <option value="delivered">Entregadas</option>
                            <option value="failed">Fallidas</option>
                        </select>
                        
                        <select id="assigneeFilter" class="form-control" onchange="filterDeliveries()" style="width: auto; min-width: 150px;">
                            <option value="all">Todos los responsables</option>
                            <option value="unassigned">Sin asignar</option>
                            <option value="socio">Socio</option>
                            <option value="yo">Yo</option>
                        </select>
                        
                        <input type="date" id="dateFilter" class="form-control" onchange="filterDeliveries()" style="width: auto;">
                    </div>
                    
                    <div id="deliveriesContainer">
                        <p style="text-align: center; color: #666; padding: 2rem;">No hay entregas para mostrar</p>
                    </div>
                </div>

                <!-- Gastos -->
                <div id="expenses" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>Gastos</h2>
                        <button class="btn btn-danger" onclick="openModal('expenseModal')">+ Nuevo Gasto</button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                    No hay gastos. Registra tu primer gasto.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Flujo de Caja -->
                <div id="cashflow" class="section">
                    <h2>Flujo de Caja</h2>
                    <div class="stats-grid">
                        <div class="stat-card" style="background: #d4edda;">
                            <div class="stat-value" id="todayIncome">‚Ç≤0</div>
                            <div class="stat-label">Ingresos Hoy</div>
                        </div>
                        <div class="stat-card" style="background: #f8d7da;">
                            <div class="stat-value" id="todayExpenses">‚Ç≤0</div>
                            <div class="stat-label">Gastos Hoy</div>
                        </div>
                        <div class="stat-card" style="background: #e2e3e5;">
                            <div class="stat-value" id="todayNet">‚Ç≤0</div>
                            <div class="stat-label">Neto Hoy</div>
                        </div>
                    </div>

                    <h3>Transacciones de Hoy</h3>
                    <div id="todayTransactions" style="margin-top: 1rem;">
                        <p style="text-align: center; color: #666; padding: 2rem;">No hay transacciones hoy</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Producto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h3>Nuevo Producto</h3>
            
            <div class="form-group">
                <label>Nombre del Producto *</label>
                <input type="text" class="form-control" id="productName" required>
            </div>
            
            <div class="form-group">
                <label>Proveedor *</label>
                <input type="text" class="form-control" id="productSupplier" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" class="form-control" id="productStock" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Costo (‚Ç≤) *</label>
                    <input type="number" class="form-control" id="productCost" required min="0">
                </div>
            </div>
            
            <div class="form-group">
                <label>Precio de Venta (‚Ç≤) *</label>
                <input type="number" class="form-control" id="productPrice" required min="0">
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn" onclick="closeModal('productModal')">Cancelar</button>
                <button class="btn btn-success" onclick="saveProduct()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Pedido -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h3>Nuevo Pedido</h3>
            
            <div class="form-group">
                <label>Cliente *</label>
                <input type="text" class="form-control" id="orderCustomer" required>
            </div>
            
            <div class="form-group">
                <label>Producto *</label>
                <select class="form-control" id="orderProduct" onchange="updateOrderPrice()" required>
                    <option value="">Seleccionar producto...</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Cantidad *</label>
                    <input type="number" class="form-control" id="orderQuantity" value="1" min="1" onchange="updateOrderPrice()">
                </div>
                <div class="form-group">
                    <label>Total (‚Ç≤) *</label>
                    <input type="number" class="form-control" id="orderTotal" required readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label>Estado</label>
                <select class="form-control" id="orderStatus">
                    <option value="pending">Pendiente</option>
                    <option value="confirmed">Confirmado</option>
                    <option value="delivered">Entregado</option>
                    <option value="cancelled">Cancelado</option>
                </select>
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn" onclick="closeModal('orderModal')">Cancelar</button>
                <button class="btn btn-info" onclick="saveOrder()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Estado -->
    <div id="editStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editStatusModal')">&times;</span>
            <h3>Editar Estado del Pedido</h3>
            
            <div class="form-group">
                <label>Cliente</label>
                <input type="text" class="form-control" id="editStatusCustomer" readonly>
            </div>
            
            <div class="form-group">
                <label>Producto</label>
                <input type="text" class="form-control" id="editStatusProduct" readonly>
            </div>
            
            <div class="form-group">
                <label>Estado *</label>
                <select class="form-control" id="editStatusValue" required>
                    <option value="pending">Pendiente</option>
                    <option value="confirmed">Confirmado</option>
                    <option value="delivered">Entregado</option>
                    <option value="cancelled">Cancelado</option>
                </select>
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn" onclick="closeModal('editStatusModal')">Cancelar</button>
                <button class="btn btn-success" onclick="updateOrderStatus()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Entrega -->
    <div id="assignDeliveryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignDeliveryModal')">&times;</span>
            <h3>Asignar Entrega</h3>
            
            <div class="form-group">
                <label>Cliente</label>
                <input type="text" class="form-control" id="assignCustomer" readonly>
            </div>
            
            <div class="form-group">
                <label>Producto</label>
                <input type="text" class="form-control" id="assignProduct" readonly>
            </div>
            
            <div class="form-group">
                <label>Responsable de Entrega *</label>
                <select class="form-control" id="assignResponsible" required>
                    <option value="">Seleccionar...</option>
                    <option value="socio">Socio</option>
                    <option value="yo">Yo</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Fecha Programada *</label>
                <input type="date" class="form-control" id="assignDate" required>
            </div>
            
            <div class="form-group">
                <label>Notas</label>
                <textarea class="form-control" id="assignNotes" rows="3" placeholder="Direcci√≥n, horarios, etc."></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn" onclick="closeModal('assignDeliveryModal')">Cancelar</button>
                <button class="btn btn-success" onclick="saveDeliveryAssignment()">Asignar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gasto -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            <h3>Nuevo Gasto</h3>
            
            <div class="form-group">
                <label>Descripci√≥n *</label>
                <input type="text" class="form-control" id="expenseDescription" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Monto (‚Ç≤) *</label>
                    <input type="number" class="form-control" id="expenseAmount" required min="1">
                </div>
                <div class="form-group">
                    <label>Fecha *</label>
                    <input type="date" class="form-control" id="expenseDate" required>
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn" onclick="closeModal('expenseModal')">Cancelar</button>
                <button class="btn btn-danger" onclick="saveExpense()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let products = [];
        let orders = [];
        let expenses = [];
        let transactions = [];
        let deliveries = [];
        let currentEditingOrderId = null;
        let currentAssigningDeliveryId = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setTodayDate();
            updateAllDisplays();
            console.log('ERP iniciado correctamente');
        });

        // Funciones b√°sicas
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            document.getElementById(sectionName).classList.add('active');
            
            // Actualizar men√∫
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Actualizar datos seg√∫n la secci√≥n
            if (sectionName === 'products') updateProductsTable();
            if (sectionName === 'orders') updateOrdersTable();
            if (sectionName === 'expenses') updateExpensesTable();
            if (sectionName === 'deliveries') {
                syncDeliveries();
                updateDeliveriesDisplay();
            }
            if (sectionName === 'cashflow') updateCashflowDisplay();
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            if (modalId === 'orderModal') {
                populateProductSelect();
            }
            if (modalId === 'assignDeliveryModal') {
                document.getElementById('assignDate').value = getTodayString();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            clearForm(modalId);
        }

        function clearForm(modalId) {
            const modal = document.getElementById(modalId);
            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = input.id === 'productStock' ? '0' : 
                                  input.id === 'orderQuantity' ? '1' : '';
                } else if (input.type === 'date') {
                    input.value = getTodayString();
                } else {
                    input.value = '';
                }
            });
        }

        // Funciones de guardado
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const supplier = document.getElementById('productSupplier').value.trim();
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const cost = parseFloat(document.getElementById('productCost').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value) || 0;

            if (!name || !supplier || cost <= 0 || price <= 0) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            const product = {
                id: Date.now().toString(),
                name,
                supplier,
                stock,
                cost,
                price,
                created: new Date().toISOString()
            };

            products.push(product);
            saveData();
            updateAllDisplays();
            closeModal('productModal');
            alert('Producto guardado correctamente');
        }

        function saveOrder() {
            const customer = document.getElementById('orderCustomer').value.trim();
            const productId = document.getElementById('orderProduct').value;
            const quantity = parseInt(document.getElementById('orderQuantity').value) || 1;
            const total = parseFloat(document.getElementById('orderTotal').value) || 0;
            const status = document.getElementById('orderStatus').value;

            if (!customer || !productId || quantity <= 0 || total <= 0) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Producto no encontrado');
                return;
            }

            if (product.stock < quantity) {
                alert(`Stock insuficiente. Disponible: ${product.stock}`);
                return;
            }

            // Crear pedido
            const order = {
                id: Date.now().toString(),
                customer,
                productId,
                productName: product.name,
                quantity,
                total,
                status,
                created: new Date().toISOString()
            };

            // Actualizar stock
            product.stock -= quantity;
            
            // Agregar a arrays
            orders.push(order);
            
            // Crear transacci√≥n autom√°tica de ingreso
            transactions.push({
                id: Date.now().toString() + '_income',
                type: 'income',
                description: `Venta: ${customer} - ${product.name}`,
                amount: total,
                date: getTodayString(),
                created: new Date().toISOString()
            });

            saveData();
            updateAllDisplays();
            closeModal('orderModal');
            alert('Pedido guardado correctamente');
        }

        function saveExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const date = document.getElementById('expenseDate').value;

            if (!description || amount <= 0 || !date) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            const expense = {
                id: Date.now().toString(),
                description,
                amount,
                date,
                created: new Date().toISOString()
            };

            expenses.push(expense);
            
            transactions.push({
                id: Date.now().toString() + '_expense',
                type: 'expense',
                description: `Gasto: ${description}`,
                amount,
                date,
                created: new Date().toISOString()
            });

            saveData();
            updateAllDisplays();
            closeModal('expenseModal');
            alert('Gasto guardado correctamente');
        }

        // Funciones de edici√≥n de estado
        function editOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            currentEditingOrderId = orderId;
            document.getElementById('editStatusCustomer').value = order.customer;
            document.getElementById('editStatusProduct').value = order.productName;
            document.getElementById('editStatusValue').value = order.status;
            
            openModal('editStatusModal');
        }

        function updateOrderStatus() {
            if (!currentEditingOrderId) return;

            const newStatus = document.getElementById('editStatusValue').value;
            const order = orders.find(o => o.id === currentEditingOrderId);
            
            if (order) {
                order.status = newStatus;
                saveData();
                updateAllDisplays();
                closeModal('editStatusModal');
                alert('Estado del pedido actualizado');
                
                // Actualizar entrega si existe
                const delivery = deliveries.find(d => d.orderId === currentEditingOrderId);
                if (delivery) {
                    if (newStatus === 'delivered') {
                        delivery.status = 'delivered';
                        delivery.deliveredDate = getTodayString();
                    }
                    updateDeliveriesDisplay();
                }
            }
            
            currentEditingOrderId = null;
        }

        // Funciones de gesti√≥n de entregas
        function syncDeliveries() {
            // Sincronizar entregas con pedidos confirmados que no han sido cancelados
            const ordersNeedingDelivery = orders.filter(order => 
                order.status !== 'cancelled' && 
                !deliveries.find(d => d.orderId === order.id)
            );

            ordersNeedingDelivery.forEach(order => {
                const delivery = {
                    id: 'delivery_' + order.id,
                    orderId: order.id,
                    customer: order.customer,
                    productName: order.productName,
                    quantity: order.quantity,
                    total: order.total,
                    status: order.status === 'delivered' ? 'delivered' : 'pending',
                    assignedTo: null,
                    scheduledDate: null,
                    deliveredDate: order.status === 'delivered' ? order.created.split('T')[0] : null,
                    notes: '',
                    created: new Date().toISOString()
                };
                deliveries.push(delivery);
            });

            saveData();
        }

        function assignDelivery(deliveryId) {
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            currentAssigningDeliveryId = deliveryId;
            document.getElementById('assignCustomer').value = delivery.customer;
            document.getElementById('assignProduct').value = delivery.productName;
            
            openModal('assignDeliveryModal');
        }

        function saveDeliveryAssignment() {
            if (!currentAssigningDeliveryId) return;

            const delivery = deliveries.find(d => d.id === currentAssigningDeliveryId);
            if (!delivery) return;

            const responsible = document.getElementById('assignResponsible').value;
            const scheduledDate = document.getElementById('assignDate').value;
            const notes = document.getElementById('assignNotes').value;

            if (!responsible || !scheduledDate) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            delivery.assignedTo = responsible;
            delivery.scheduledDate = scheduledDate;
            delivery.notes = notes;
            delivery.status = 'assigned';

            saveData();
            updateAllDisplays();
            updateDeliveriesDisplay();
            closeModal('assignDeliveryModal');
            alert('Entrega asignada correctamente');
            
            currentAssigningDeliveryId = null;
        }

        function updateDeliveryStatus(deliveryId, newStatus) {
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            delivery.status = newStatus;
            
            if (newStatus === 'delivered') {
                delivery.deliveredDate = getTodayString();
                // Actualizar tambi√©n el pedido
                const order = orders.find(o => o.id === delivery.orderId);
                if (order) {
                    order.status = 'delivered';
                }
            } else if (newStatus === 'in-progress') {
                // Marcar como en progreso
            } else if (newStatus === 'failed') {
                // Marcar como fallida
            }

            saveData();
            updateAllDisplays();
            updateDeliveriesDisplay();
        }

        function filterDeliveries() {
            updateDeliveriesDisplay();
        }

        function updateDeliveriesDisplay() {
            const container = document.getElementById('deliveriesContainer');
            const statusFilter = document.getElementById('deliveryFilter').value;
            const assigneeFilter = document.getElementById('assigneeFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredDeliveries = [...deliveries];

            // Filtrar por estado
            if (statusFilter !== 'all') {
                filteredDeliveries = filteredDeliveries.filter(d => d.status === statusFilter);
            }

            // Filtrar por responsable
            if (assigneeFilter !== 'all') {
                if (assigneeFilter === 'unassigned') {
                    filteredDeliveries = filteredDeliveries.filter(d => !d.assignedTo);
                } else {
                    filteredDeliveries = filteredDeliveries.filter(d => d.assignedTo === assigneeFilter);
                }
            }

            // Filtrar por fecha
            if (dateFilter) {
                filteredDeliveries = filteredDeliveries.filter(d => 
                    d.scheduledDate === dateFilter || 
                    d.deliveredDate === dateFilter
                );
            }

            if (filteredDeliveries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay entregas para mostrar</p>';
                return;
            }

            container.innerHTML = filteredDeliveries.map(delivery => `
                <div class="delivery-card">
                    <div class="delivery-header">
                        <h4>${delivery.customer} - ${delivery.productName}</h4>
                        <span class="delivery-status status-${delivery.status}">${getDeliveryStatusLabel(delivery.status)}</span>
                    </div>
                    
                    <div class="delivery-info">
                        <div class="info-item">
                            <div class="info-label">Cantidad:</div>
                            <div>${delivery.quantity}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total:</div>
                            <div>${formatCurrency(delivery.total)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Responsable:</div>
                            <div>${delivery.assignedTo || 'Sin asignar'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Fecha programada:</div>
                            <div>${delivery.scheduledDate ? new Date(delivery.scheduledDate).toLocaleDateString() : 'No programada'}</div>
                        </div>
                        ${delivery.deliveredDate ? `
                        <div class="info-item">
                            <div class="info-label">Fecha entregada:</div>
                            <div>${new Date(delivery.deliveredDate).toLocaleDateString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${delivery.notes ? `
                    <div style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 5px;">
                        <strong>Notas:</strong> ${delivery.notes}
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 1rem; text-align: right;">
                        ${delivery.status === 'pending' ? `
                            <button class="btn btn-info btn-sm" onclick="assignDelivery('${delivery.id}')">Asignar</button>
                        ` : ''}
                        
                        ${delivery.status === 'assigned' ? `
                            <button class="btn btn-warning btn-sm" onclick="updateDeliveryStatus('${delivery.id}', 'in-progress')">En Camino</button>
                        ` : ''}
                        
                        ${delivery.status === 'in-progress' ? `
                            <button class="btn btn-success btn-sm" onclick="updateDeliveryStatus('${delivery.id}', 'delivered')">Entregar</button>
                            <button class="btn btn-danger btn-sm" onclick="updateDeliveryStatus('${delivery.id}', 'failed')">Fall√≥</button>
                        ` : ''}
                        
                        ${delivery.status === 'failed' ? `
                            <button class="btn btn-info btn-sm" onclick="updateDeliveryStatus('${delivery.id}', 'assigned')">Reagendar</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getDeliveryStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'assigned': 'Asignada',
                'in-progress': 'En camino',
                'delivered': 'Entregada',
                'failed': 'Fallida'
            };
            return labels[status] || status;
        }

        // Funciones de actualizaci√≥n de datos
        function updateOrderPrice() {
            const productId = document.getElementById('orderProduct').value;
            const quantity = parseInt(document.getElementById('orderQuantity').value) || 1;
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('orderTotal').value = product.price * quantity;
                }
            }
        }

        function populateProductSelect() {
            const select = document.getElementById('orderProduct');
            select.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - ${formatCurrency(product.price)} (Stock: ${product.stock})`;
                select.appendChild(option);
            });
        }

        // Funciones de actualizaci√≥n de tablas
        function updateProductsTable() {
            const tbody = document.getElementById('productsTable');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">No hay productos. Agrega tu primer producto.</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.supplier}</td>
                    <td><span style="color: ${product.stock <= 5 ? '#dc3545' : '#28a745'}">${product.stock}</span></td>
                    <td>${formatCurrency(product.cost)}</td>
                    <td>${formatCurrency(product.price)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">No hay pedidos. Crea tu primer pedido.</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>${order.customer}</strong></td>
                    <td>${order.productName}</td>
                    <td>${order.quantity}</td>
                    <td>${formatCurrency(order.total)}</td>
                    <td><span style="color: ${getStatusColor(order.status)}">${getStatusLabel(order.status)}</span></td>
                    <td>${new Date(order.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editOrderStatus('${order.id}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTable');
            
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #666;">No hay gastos. Registra tu primer gasto.</td></tr>';
                return;
            }

            tbody.innerHTML = expenses.map(expense => `
                <tr>
                    <td><strong>${expense.description}</strong></td>
                    <td>${formatCurrency(expense.amount)}</td>
                    <td>${new Date(expense.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCashflowDisplay() {
            const today = getTodayString();
            const todayTransactions = transactions.filter(t => t.date === today);
            
            const todayIncome = todayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const todayExpenseAmount = todayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const todayNet = todayIncome - todayExpenseAmount;

            document.getElementById('todayIncome').textContent = formatCurrency(todayIncome);
            document.getElementById('todayExpenses').textContent = formatCurrency(todayExpenseAmount);
            document.getElementById('todayNet').textContent = formatCurrency(todayNet);

            const container = document.getElementById('todayTransactions');
            if (todayTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hay transacciones hoy</p>';
            } else {
                container.innerHTML = todayTransactions.map(t => `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; border: 1px solid #ddd; margin-bottom: 0.5rem; border-radius: 5px;">
                        <div>
                            <strong>${t.description}</strong>
                        </div>
                        <div style="color: ${t.type === 'income' ? '#28a745' : '#dc3545'}">
                            ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateAllDisplays() {
            // Calcular totales
            const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
            const totalExpenseAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalProfit = totalRevenue - totalExpenseAmount;
            const pendingDeliveriesCount = deliveries.filter(d => d.status !== 'delivered' && d.status !== 'cancelled').length;
            const deliveredCount = deliveries.filter(d => d.status === 'delivered').length;
            const totalDeliveries = deliveries.length;
            const deliveryRate = totalDeliveries > 0 ? Math.round((deliveredCount / totalDeliveries) * 100) : 0;

            // Actualizar navbar
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenseAmount);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('pendingDeliveries').textContent = pendingDeliveriesCount;

            // Actualizar dashboard
            document.getElementById('dashProducts').textContent = products.length;
            document.getElementById('dashOrders').textContent = orders.length;
            document.getElementById('dashRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('dashProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('dashPendingDeliveries').textContent = pendingDeliveriesCount;
            document.getElementById('dashDeliveryRate').textContent = deliveryRate + '%';

            // Actualizar color de ganancia
            const profitElements = [document.getElementById('totalProfit'), document.getElementById('dashProfit')];
            profitElements.forEach(el => {
                el.style.color = totalProfit >= 0 ? '#28a745' : '#dc3545';
            });
        }

        // Funciones de eliminaci√≥n
        function deleteProduct(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                products = products.filter(p => p.id !== id);
                saveData();
                updateAllDisplays();
                updateProductsTable();
            }
        }

        function deleteOrder(id) {
            if (confirm('¬øEst√°s seguro de eliminar este pedido?')) {
                const order = orders.find(o => o.id === id);
                if (order) {
                    // Restaurar stock
                    const product = products.find(p => p.id === order.productId);
                    if (product) {
                        product.stock += order.quantity;
                    }
                    
                    // Eliminar transacci√≥n relacionada
                    transactions = transactions.filter(t => !t.description.includes(order.customer));
                    
                    // Eliminar entrega relacionada
                    deliveries = deliveries.filter(d => d.orderId !== id);
                }
                
                orders = orders.filter(o => o.id !== id);
                saveData();
                updateAllDisplays();
                updateOrdersTable();
                updateDeliveriesDisplay();
            }
        }

        function deleteExpense(id) {
            if (confirm('¬øEst√°s seguro de eliminar este gasto?')) {
                const expense = expenses.find(e => e.id === id);
                if (expense) {
                    transactions = transactions.filter(t => !t.description.includes(expense.description));
                }
                
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                updateAllDisplays();
                updateExpensesTable();
            }
        }

        // Funciones auxiliares
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PY', {
                style: 'currency',
                currency: 'PYG',
                minimumFractionDigits: 0
            }).format(amount || 0).replace('PYG', '‚Ç≤');
        }

        function getTodayString() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function setTodayDate() {
            const today = getTodayString();
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => input.value = today);
        }

        function getStatusColor(status) {
            const colors = {
                'pending': '#ffc107',
                'confirmed': '#17a2b8',
                'delivered': '#28a745',
                'cancelled': '#dc3545'
            };
            return colors[status] || '#6c757d';
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmado',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            return labels[status] || status;
        }

        function generateSampleData() {
            if (confirm('¬øGenerar datos de ejemplo? Esto agregar√° productos, pedidos y gastos de prueba.')) {
                // Productos de ejemplo
                const sampleProducts = [
                    { name: 'Auriculares Bluetooth', supplier: 'TechSupplier', stock: 25, cost: 45000, price: 89000 },
                    { name: 'Camiseta Deportiva', supplier: 'SportWear', stock: 50, cost: 25000, price: 55000 },
                    { name: 'L√°mpara LED', supplier: 'HomeDecor', stock: 15, cost: 35000, price: 75000 }
                ];

                sampleProducts.forEach(productData => {
                    products.push({
                        id: Date.now().toString() + Math.random(),
                        ...productData,
                        created: new Date().toISOString()
                    });
                });

                // Pedidos de ejemplo
                const sampleOrders = [
                    { customer: 'Mar√≠a Gonz√°lez', productIndex: 0, quantity: 1, status: 'confirmed' },
                    { customer: 'Carlos Rodr√≠guez', productIndex: 1, quantity: 2, status: 'delivered' },
                    { customer: 'Ana P√©rez', productIndex: 2, quantity: 1, status: 'pending' }
                ];

                sampleOrders.forEach(orderData => {
                    const product = products[orderData.productIndex];
                    if (product && product.stock >= orderData.quantity) {
                        const total = product.price * orderData.quantity;
                        
                        orders.push({
                            id: Date.now().toString() + Math.random(),
                            customer: orderData.customer,
                            productId: product.id,
                            productName: product.name,
                            quantity: orderData.quantity,
                            total,
                            status: orderData.status,
                            created: new Date().toISOString()
                        });

                        product.stock -= orderData.quantity;

                        transactions.push({
                            id: Date.now().toString() + Math.random(),
                            type: 'income',
                            description: `Venta: ${orderData.customer} - ${product.name}`,
                            amount: total,
                            date: getTodayString(),
                            created: new Date().toISOString()
                        });
                    }
                });

                // Gastos de ejemplo
                const sampleExpenses = [
                    { description: 'Facebook Ads', amount: 150000 },
                    { description: 'Combustible delivery', amount: 35000 }
                ];

                sampleExpenses.forEach(expenseData => {
                    expenses.push({
                        id: Date.now().toString() + Math.random(),
                        ...expenseData,
                        date: getTodayString(),
                        created: new Date().toISOString()
                    });

                    transactions.push({
                        id: Date.now().toString() + Math.random(),
                        type: 'expense',
                        description: `Gasto: ${expenseData.description}`,
                        amount: expenseData.amount,
                        date: getTodayString(),
                        created: new Date().toISOString()
                    });
                });

                saveData();
                syncDeliveries();
                updateAllDisplays();
                alert('Datos de ejemplo cargados correctamente');
            }
        }

        // Persistencia de datos
        function saveData() {
            localStorage.setItem('berserker_products', JSON.stringify(products));
            localStorage.setItem('berserker_orders', JSON.stringify(orders));
            localStorage.setItem('berserker_expenses', JSON.stringify(expenses));
            localStorage.setItem('berserker_transactions', JSON.stringify(transactions));
            localStorage.setItem('berserker_deliveries', JSON.stringify(deliveries));
        }

        function loadData() {
            products = JSON.parse(localStorage.getItem('berserker_products') || '[]');
            orders = JSON.parse(localStorage.getItem('berserker_orders') || '[]');
            expenses = JSON.parse(localStorage.getItem('berserker_expenses') || '[]');
            transactions = JSON.parse(localStorage.getItem('berserker_transactions') || '[]');
            deliveries = JSON.parse(localStorage.getItem('berserker_deliveries') || '[]');
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        console.log('BERSERKER.CO ERP - Versi√≥n Completa con Gesti√≥n de Entregas cargada correctamente');
    </script>
</body>
</html>
